<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çµ±åˆã‚¿ã‚¤ãƒ ã‚«ãƒ¼ãƒ‰ã‚·ã‚¹ãƒ†ãƒ </title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Hiragino Sans', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #1e293b;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .debug {
            position: fixed;
            top: 10px;
            left: 10px;
            right: 10px;
            background: #ef4444;
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            z-index: 1000;
            display: none;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .mode-toggle {
            text-align: center;
            margin-bottom: 30px;
        }

        .toggle-btn {
            padding: 12px 24px;
            margin: 0 10px;
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 12px;
            font-weight: bold;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .toggle-btn.active {
            background: white;
            color: #4f46e5;
            border-color: white;
        }

        .mode-section {
            display: none;
        }

        .mode-section.active {
            display: block;
        }

        .card {
            background: white;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }

        /* å¾“æ¥­å“¡ãƒ¢ãƒ¼ãƒ‰ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .employee-info {
            margin-top: 0.5rem;
            padding: 0.75rem;
            background: #f0f9ff;
            border: 2px solid #0ea5e9;
            border-radius: 8px;
            text-align: center;
        }

        .employee-name {
            font-size: 1.1rem;
            font-weight: bold;
            color: #0c4a6e;
            margin-bottom: 0.25rem;
        }

        .employee-dept {
            font-size: 0.9rem;
            color: #0369a1;
            font-weight: 500;
        }

        .input-group {
            margin-bottom: 2rem;
        }

        .label {
            display: block;
            font-weight: bold;
            margin-bottom: 0.5rem;
            font-size: 1.1rem;
        }

        .input {
            width: 100%;
            padding: 1rem;
            border: 3px solid #e2e8f0;
            border-radius: 12px;
            font-size: 1.5rem;
            text-align: center;
            font-weight: bold;
            font-family: monospace;
            background: #f8fafc;
        }

        .input:focus {
            border-color: #667eea;
            outline: none;
            background: white;
        }

        .buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        @media (max-width: 480px) {
            .buttons {
                grid-template-columns: 1fr;
            }
        }

        .button {
            padding: 20px 15px;
            border: none;
            border-radius: 15px;
            font-size: 1rem;
            font-weight: bold;
            color: white;
            cursor: pointer;
            min-height: 80px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 8px;
            -webkit-tap-highlight-color: rgba(255,255,255,0.3);
            -webkit-user-select: none;
            -moz-user-select: none;
            user-select: none;
            touch-action: manipulation;
            transition: all 0.1s ease;
        }

        .button:active,
        .button:focus {
            transform: scale(0.95);
            outline: none;
        }

        .btn-1 { background: #10b981; }
        .btn-2 { background: #3b82f6; }
        .btn-3 { background: #f59e0b; }
        .btn-4 { background: #8b5cf6; }

        .icon {
            font-size: 1.8rem;
        }

        .message {
            background: #dcfce7;
            color: #166534;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-weight: bold;
            text-align: center;
            display: none;
        }

        .message.error {
            background: #fecaca;
            color: #dc2626;
        }

        .download {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
            color: white;
            border: none;
            border-radius: 12px;
            font-weight: bold;
            cursor: pointer;
            font-size: 1.1rem;
            box-shadow: 0 4px 8px rgba(139, 92, 246, 0.3);
        }

        .download:active {
            transform: translateY(1px);
        }

        /* ç®¡ç†è€…ãƒ¢ãƒ¼ãƒ‰ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            text-align: center;
        }

        .stat-number {
            font-size: 3rem;
            font-weight: bold;
            color: #4f46e5;
            margin-bottom: 10px;
        }

        .stat-label {
            font-size: 1.1rem;
            color: #64748b;
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: #1e293b;
            margin-bottom: 20px;
            border-bottom: 3px solid #4f46e5;
            padding-bottom: 10px;
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 25px;
            align-items: center;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .control-label {
            font-weight: bold;
            color: #374151;
            font-size: 0.9rem;
        }

        .control-input {
            padding: 8px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 0.9rem;
        }

        .btn {
            padding: 10px 20px;
            background: #4f46e5;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .btn:hover {
            background: #3730a3;
        }

        .btn-success {
            background: #10b981;
        }

        .btn-success:hover {
            background: #047857;
        }

        .records-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .records-table th {
            background: #4f46e5;
            color: white;
            padding: 15px 12px;
            text-align: left;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .records-table td {
            padding: 12px;
            border-bottom: 1px solid #e2e8f0;
            font-size: 0.9rem;
        }

        .records-table tbody tr:hover {
            background: #f8fafc;
        }

        .dept-badge {
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .dept-æœ¬éƒ¨ { background: #dbeafe; color: #1e40af; }
        .dept-äº‹æ¥­æ¨é€²éƒ¨ { background: #d1fae5; color: #065f46; }
        .dept-ãƒªã‚µã‚¤ã‚¯ãƒ«éƒ¨ { background: #fef3c7; color: #92400e; }
        .dept-é…é” { background: #e0e7ff; color: #3730a3; }
        .dept-é‹æ¬ { background: #fde2e8; color: #9f1239; }

        .type-badge {
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .type-checkin { background: #d1fae5; color: #065f46; }
        .type-checkout { background: #fde2e8; color: #9f1239; }
        .type-out { background: #fef3c7; color: #92400e; }
        .type-return { background: #dbeafe; color: #1e40af; }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #64748b;
            font-size: 1.1rem;
        }

        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
                align-items: stretch;
            }

            .control-group {
                width: 100%;
            }

            .control-input {
                width: 100%;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="debug" id="debug">DEBUG</div>
    
    <div class="container">
        <div class="header">
            <h1>ğŸ“± çµ±åˆã‚¿ã‚¤ãƒ ã‚«ãƒ¼ãƒ‰ã‚·ã‚¹ãƒ†ãƒ </h1>
            <div>å¾“æ¥­å“¡æ‰“åˆ»ï¼‹ç®¡ç†æ©Ÿèƒ½</div>
        </div>

        <!-- ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ -->
        <div class="mode-toggle">
            <button class="toggle-btn active" onclick="switchMode('employee')">ğŸ‘¤ å¾“æ¥­å“¡ãƒ¢ãƒ¼ãƒ‰</button>
            <button class="toggle-btn" onclick="switchMode('admin')">ğŸ“Š ç®¡ç†è€…ãƒ¢ãƒ¼ãƒ‰</button>
        </div>

        <!-- å¾“æ¥­å“¡ãƒ¢ãƒ¼ãƒ‰ -->
        <div id="employeeMode" class="mode-section active">
            <!-- åˆå›è¨­å®šç”»é¢ -->
            <div id="setupScreen" style="display: none;">
                <div class="card">
                    <h2 style="text-align: center; margin-bottom: 20px;">ğŸ“± ãƒ‡ãƒã‚¤ã‚¹ç™»éŒ²</h2>
                    <div style="text-align: center; font-size: 0.9rem; color: #666; margin-bottom: 20px;">
                        åˆå›ã®ã¿ï¼šã‚ãªãŸã®æºå¸¯é›»è©±ã‚’ç¤¾å“¡ç•ªå·ã¨ç´ä»˜ã‘ã¾ã™
                    </div>

                    <div class="input-group">
                        <label class="label">ğŸ‘¤ ã‚ãªãŸã®ç¤¾å“¡ã‚³ãƒ¼ãƒ‰ï¼ˆ4æ¡ï¼‰</label>
                        <input type="tel" class="input" id="setupEmpno" placeholder="2088" maxlength="4" autocomplete="off" inputmode="numeric">
                        <div style="font-size: 0.8rem; color: #666; margin-top: 5px;">
                            ä¾‹: 2088ï¼ˆå²©åŸæ­£äºŒï¼‰ã€1048ï¼ˆé…’äº•äºŒä¸‰ç”·ï¼‰
                        </div>
                    </div>

                    <button onclick="registerDevice()" style="width: 100%; padding: 15px; background: #10b981; color: white; border: none; border-radius: 10px; font-size: 1.1rem; font-weight: bold; margin-top: 20px;">
                        ğŸ“± ã“ã®æºå¸¯ã‚’ç™»éŒ²
                    </button>

                    <div style="background: #f0f9ff; border: 1px solid #0ea5e9; border-radius: 8px; padding: 15px; margin-top: 20px; font-size: 0.9rem;">
                        <div style="font-weight: bold; color: #0369a1; margin-bottom: 8px;">ğŸ“ æ³¨æ„äº‹é …</div>
                        <div style="color: #0c4a6e;">
                            â€¢ ä¸€åº¦ç™»éŒ²ã™ã‚‹ã¨ã€æ¬¡å›ã‹ã‚‰ã¯ç¤¾å“¡ã‚³ãƒ¼ãƒ‰å…¥åŠ›ä¸è¦<br>
                            â€¢ ã“ã®æºå¸¯ã‹ã‚‰ãƒ¯ãƒ³ã‚¿ãƒƒãƒ—ã§æ‰“åˆ»ã§ãã¾ã™<br>
                            â€¢ ä»–ã®æºå¸¯ã§ã¯åˆ¥é€”ç™»éŒ²ãŒå¿…è¦ã§ã™
                        </div>
                    </div>
                </div>
            </div>

            <!-- ãƒ¡ã‚¤ãƒ³ç”»é¢ -->
            <div id="mainScreen" style="display: none;">
                <div class="card">
                    <div style="text-align: center; margin-bottom: 20px;">
                        <div style="font-size: 2rem; font-weight: bold; color: #4f46e5; margin-bottom: 10px;" id="clock">00:00:00</div>
                    </div>

                    <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±è¡¨ç¤º -->
                    <div style="background: #f0f9ff; border: 2px solid #0ea5e9; border-radius: 12px; padding: 15px; margin-bottom: 20px;">
                        <div style="text-align: center;">
                            <div style="font-size: 1.2rem; font-weight: bold; color: #0c4a6e; margin-bottom: 5px;">
                                ğŸ‘¤ <span id="currentUserName">ãƒ¦ãƒ¼ã‚¶ãƒ¼å</span>
                            </div>
                            <div style="font-size: 0.9rem; color: #0369a1; margin-bottom: 5px;">
                                ğŸ¢ <span id="currentUserDept">éƒ¨ç½²å</span>
                            </div>
                            <div style="font-size: 0.8rem; color: #0284c7;">
                                ğŸ†” <span id="currentUserCode">0000</span>
                            </div>
                        </div>
                        <div style="text-align: center; margin-top: 10px;">
                            <button onclick="clearDeviceInfo()" style="background: #ef4444; color: white; border: none; padding: 5px 10px; border-radius: 5px; font-size: 0.8rem;">
                                ğŸ”„ ãƒ‡ãƒã‚¤ã‚¹è¨­å®šãƒªã‚»ãƒƒãƒˆ
                            </button>
                        </div>
                    </div>

                    <div class="message" id="message"></div>

                    <div class="buttons">
                        <button class="button btn-1" data-type="checkin">
                            <div class="icon">ğŸ•˜</div>
                            <div>å‡ºå‹¤</div>
                        </button>
                        <button class="button btn-2" data-type="checkout">
                            <div class="icon">ğŸ </div>
                            <div>é€€å‹¤</div>
                        </button>
                        <button class="button btn-3" data-type="out">
                            <div class="icon">ğŸš—</div>
                            <div>å¤–å‡º</div>
                        </button>
                        <button class="button btn-4" data-type="return">
                            <div class="icon">ğŸ”™</div>
                            <div>æˆ»ã‚Š</div>
                        </button>
                    </div>

                    <button class="download" onclick="downloadCSV()">ğŸ“Š CSV ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
                </div>
            </div>
        </div>

        <!-- ç®¡ç†è€…ãƒ¢ãƒ¼ãƒ‰ -->
        <div id="adminMode" class="mode-section">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalRecords">0</div>
                    <div class="stat-label">ç·æ‰“åˆ»æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="todayRecords">0</div>
                    <div class="stat-label">æœ¬æ—¥æ‰“åˆ»æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="activeUsers">0</div>
                    <div class="stat-label">åˆ©ç”¨è€…æ•°/ç·åœ¨ç±æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="departments">5</div>
                    <div class="stat-label">éƒ¨ç½²æ•°</div>
                </div>
            </div>

            <div class="card">
                <h2 class="section-title">ğŸ” å‹¤æ€ ãƒ‡ãƒ¼ã‚¿æ¤œç´¢ãƒ»è¡¨ç¤º</h2>
                
                <div class="controls">
                    <div class="control-group">
                        <label class="control-label">ğŸ“… æ—¥ä»˜</label>
                        <input type="date" id="dateFilter" class="control-input">
                    </div>
                    <div class="control-group">
                        <label class="control-label">ğŸ¢ éƒ¨ç½²</label>
                        <select id="deptFilter" class="control-input">
                            <option value="">å…¨éƒ¨ç½²</option>
                            <option value="æœ¬éƒ¨">æœ¬éƒ¨</option>
                            <option value="äº‹æ¥­æ¨é€²éƒ¨">äº‹æ¥­æ¨é€²éƒ¨</option>
                            <option value="ãƒªã‚µã‚¤ã‚¯ãƒ«éƒ¨">ãƒªã‚µã‚¤ã‚¯ãƒ«éƒ¨</option>
                            <option value="é…é”">é…é”</option>
                            <option value="é‹æ¬">é‹æ¬</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label class="control-label">ğŸ‘¤ ç¤¾å“¡ç•ªå·</label>
                        <input type="text" id="empFilter" class="control-input" placeholder="0000">
                    </div>
                    <div class="control-group">
                        <label class="control-label">ğŸ“‹ ç¨®åˆ¥</label>
                        <select id="typeFilter" class="control-input">
                            <option value="">å…¨ç¨®åˆ¥</option>
                            <option value="checkin">å‡ºå‹¤</option>
                            <option value="checkout">é€€å‹¤</option>
                            <option value="out">å¤–å‡º</option>
                            <option value="return">æˆ»ã‚Š</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label class="control-label">ğŸ‘¥ åœ¨ç±çŠ¶æ³</label>
                        <select id="statusFilter" class="control-input">
                            <option value="active">åœ¨ç±è€…ã®ã¿</option>
                            <option value="all">åœ¨ç±è€…+é€€è·è€…</option>
                            <option value="retired">é€€è·è€…ã®ã¿</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label class="control-label">ã€€</label>
                        <button class="btn" onclick="filterRecords()">ğŸ” æ¤œç´¢</button>
                    </div>
                    <div class="control-group">
                        <label class="control-label">ã€€</label>
                        <button class="btn btn-success" onclick="exportAdminCSV()">ğŸ“Š CSVå‡ºåŠ›</button>
                    </div>
                </div>

                <div style="max-height: 500px; overflow-y: auto;">
                    <table class="records-table">
                        <thead>
                            <tr>
                                <th>æ—¥ä»˜</th>
                                <th>æ™‚åˆ»</th>
                                <th>ç¤¾å“¡ç•ªå·</th>
                                <th>æ°å</th>
                                <th>éƒ¨ç½²</th>
                                <th>ç¨®åˆ¥</th>
                            </tr>
                        </thead>
                        <tbody id="recordsBody">
                            <tr>
                                <td colspan="6" class="no-data">
                                    ğŸ“± å¾“æ¥­å“¡ãƒ¢ãƒ¼ãƒ‰ã§æ‰“åˆ»ã™ã‚‹ã¨ã€ã“ã¡ã‚‰ã«ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¡¨ç¤ºã•ã‚Œã¾ã™
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="card">
                <h2 class="section-title">âš™ï¸ ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h2>
                <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                    <button class="btn" onclick="loadTestData()">ğŸ“‹ ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿è¿½åŠ </button>
                    <button class="btn" onclick="clearAllData()">ğŸ—‘ï¸ å…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤</button>
                    <button class="btn" onclick="refreshAdminData()">ğŸ”„ ãƒ‡ãƒ¼ã‚¿æ›´æ–°</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let data = [];
        let allRecords = [];
        let isProcessing = false;
        let currentUser = null;
        let deviceId = null;

        // ç¤¾å“¡ãƒã‚¹ã‚¿ï¼ˆ40åå¯¾å¿œãƒ»é€€è·è€…ç®¡ç†ï¼‰
        var employees = {
            // æœ¬éƒ¨
            '0078': { name: 'ä¸­æ‘ æ‚ ', dept: 'æœ¬éƒ¨', status: 'active', hireDate: '2020-04-01' },
            '0084': { name: 'æ¾æœ¬ é–ç”Ÿ', dept: 'æœ¬éƒ¨', status: 'active', hireDate: '2019-10-15' },
            '0086': { name: 'æ¨ªå±± çœŸç”Ÿ', dept: 'æœ¬éƒ¨', status: 'active', hireDate: '2021-03-01' },
            '0085': { name: 'ä»å†… æ±Ÿç¾', dept: 'æœ¬éƒ¨', status: 'active', hireDate: '2018-07-01' },
            '0101': { name: 'è¶Šæ™º å®å¿—', dept: 'æœ¬éƒ¨', status: 'active', hireDate: '2022-01-15' },
            '0028': { name: 'æ–°ç•  å¯¿ç¾æ±Ÿ', dept: 'æœ¬éƒ¨', status: 'active', hireDate: '2017-05-01' },

            // äº‹æ¥­æ¨é€²éƒ¨
            '1048': { name: 'é…’äº• äºŒä¸‰ç”·', dept: 'äº‹æ¥­æ¨é€²éƒ¨', status: 'active', hireDate: '2019-04-01' },
            '1072': { name: 'äº•ä¸Š ç¶¾å¸Œ', dept: 'äº‹æ¥­æ¨é€²éƒ¨', status: 'active', hireDate: '2020-06-01' },
            '1081': { name: 'ç­†ç”° å¤§è¼”', dept: 'äº‹æ¥­æ¨é€²éƒ¨', status: 'active', hireDate: '2021-08-15' },
            '1085': { name: 'æ²–åŸ å¥', dept: 'äº‹æ¥­æ¨é€²éƒ¨', status: 'active', hireDate: '2020-11-01' },
            '1087': { name: 'å°å³¶ ç¿”å¤ª', dept: 'äº‹æ¥­æ¨é€²éƒ¨', status: 'active', hireDate: '2022-03-01' },
            '1089': { name: 'æ±è°· ç´”æ²»', dept: 'äº‹æ¥­æ¨é€²éƒ¨', status: 'active', hireDate: '2019-09-01' },
            '1094': { name: 'å°å³¶ æ „äºŒ', dept: 'äº‹æ¥­æ¨é€²éƒ¨', status: 'active', hireDate: '2021-12-01' },
            '1098': { name: 'å®®è„‡ é †', dept: 'äº‹æ¥­æ¨é€²éƒ¨', status: 'active', hireDate: '2022-08-01' },
            '1088': { name: 'æŸ¿ç”° å…¬å¹³', dept: 'äº‹æ¥­æ¨é€²éƒ¨', status: 'active', hireDate: '2020-02-15' },
            '1073': { name: 'æ± ç”° ç›´è¡Œ', dept: 'äº‹æ¥­æ¨é€²éƒ¨', status: 'active', hireDate: '2018-12-01' },

            // ãƒªã‚µã‚¤ã‚¯ãƒ«éƒ¨
            '2075': { name: 'ç€¬æˆ¸ è‰¯å­', dept: 'ãƒªã‚µã‚¤ã‚¯ãƒ«éƒ¨', status: 'active', hireDate: '2019-07-01' },
            '2077': { name: 'è¿‘è—¤ å„ªæ¨¹', dept: 'ãƒªã‚µã‚¤ã‚¯ãƒ«éƒ¨', status: 'active', hireDate: '2020-09-01' },
            '2081': { name: 'æ¸¡é‚Š é™½ä»‹', dept: 'ãƒªã‚µã‚¤ã‚¯ãƒ«éƒ¨', status: 'active', hireDate: '2021-06-01' },
            '2088': { name: 'å²©åŸ æ­£äºŒ', dept: 'ãƒªã‚µã‚¤ã‚¯ãƒ«éƒ¨', status: 'active', hireDate: '2018-08-01' },
            '2100': { name: 'ç¦é¦¬ æ³°æµ', dept: 'ãƒªã‚µã‚¤ã‚¯ãƒ«éƒ¨', status: 'active', hireDate: '2022-11-01' },

            // é…é”
            '3089': { name: 'å°å· è€•äºŒ', dept: 'é…é”', status: 'active', hireDate: '2020-01-15' },
            '3081': { name: 'èˆ¹è¶Š åŒ ', dept: 'é…é”', status: 'active', hireDate: '2019-11-01' },
            '3082': { name: 'ä¸­ç”° éš†ä¸‰', dept: 'é…é”', status: 'active', hireDate: '2021-04-01' },
            '3093': { name: 'ä¸­å…ƒ ä¸€å·³', dept: 'é…é”', status: 'active', hireDate: '2020-08-01' },

            // é€€è·è€…ï¼ˆãƒ†ã‚¹ãƒˆç”¨ï¼‰
            '0099': { name: 'é€€è·è€…A', dept: 'æœ¬éƒ¨', status: 'retired', hireDate: '2018-04-01', retireDate: '2024-12-31' }
        };

        // ===== å…±é€šæ©Ÿèƒ½ =====

        // ãƒ‡ãƒãƒƒã‚°è¡¨ç¤º
        function debug(msg) {
            var time = new Date().toLocaleTimeString();
            var fullMsg = time + ': ' + msg;
            console.log('DEBUG:', fullMsg);
            var debugEl = document.getElementById('debug');
            if (debugEl) {
                debugEl.textContent = fullMsg;
                debugEl.style.display = 'block';
                setTimeout(function() {
                    debugEl.style.display = 'none';
                }, 5000);
            }
        }

        // ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ
        function switchMode(mode) {
            const employeeMode = document.getElementById('employeeMode');
            const adminMode = document.getElementById('adminMode');
            const toggleBtns = document.querySelectorAll('.toggle-btn');

            toggleBtns.forEach(btn => btn.classList.remove('active'));

            if (mode === 'employee') {
                employeeMode.classList.add('active');
                adminMode.classList.remove('active');
                toggleBtns[0].classList.add('active');
                checkAutoLogin();
            } else {
                employeeMode.classList.remove('active');
                adminMode.classList.add('active');
                toggleBtns[1].classList.add('active');
                refreshAdminData();
            }
        }

        // ===== å¾“æ¥­å“¡ãƒ¢ãƒ¼ãƒ‰æ©Ÿèƒ½ =====

        // ãƒ‡ãƒã‚¤ã‚¹å›ºæœ‰IDç”Ÿæˆ
        function generateDeviceId() {
            return 'device_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // ãƒ‡ãƒã‚¤ã‚¹æƒ…å ±å–å¾—
        function getDeviceInfo() {
            try {
                var saved = localStorage.getItem('unified-timecard-device');
                if (saved) {
                    return JSON.parse(saved);
                }
                return null;
            } catch (e) {
                debug('ãƒ‡ãƒã‚¤ã‚¹æƒ…å ±èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ' + e.message);
                return null;
            }
        }

        // ãƒ‡ãƒã‚¤ã‚¹æƒ…å ±ä¿å­˜
        function saveDeviceInfo(empno, empInfo) {
            try {
                var deviceInfo = {
                    deviceId: deviceId,
                    employeeNumber: empno,
                    employeeName: empInfo.name,
                    employeeDept: empInfo.dept,
                    registeredAt: new Date().toISOString()
                };
                localStorage.setItem('unified-timecard-device', JSON.stringify(deviceInfo));
                debug('ãƒ‡ãƒã‚¤ã‚¹ç™»éŒ²å®Œäº†: ' + empInfo.name);
                return true;
            } catch (e) {
                debug('ãƒ‡ãƒã‚¤ã‚¹ä¿å­˜ã‚¨ãƒ©ãƒ¼: ' + e.message);
                return false;
            }
        }

        // ãƒ‡ãƒã‚¤ã‚¹æƒ…å ±å‰Šé™¤
        function clearDeviceInfo() {
            try {
                localStorage.removeItem('unified-timecard-device');
                currentUser = null;
                debug('ãƒ‡ãƒã‚¤ã‚¹æƒ…å ±ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
                showInitialSetup();
            } catch (e) {
                debug('ã‚¯ãƒªã‚¢ã‚¨ãƒ©ãƒ¼: ' + e.message);
            }
        }

        // åˆå›è¨­å®šç”»é¢è¡¨ç¤º
        function showInitialSetup() {
            document.getElementById('setupScreen').style.display = 'block';
            document.getElementById('mainScreen').style.display = 'none';
        }

        // ãƒ¡ã‚¤ãƒ³ç”»é¢è¡¨ç¤º
        function showMainScreen() {
            document.getElementById('setupScreen').style.display = 'none';
            document.getElementById('mainScreen').style.display = 'block';
            updateUserInfo();
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±è¡¨ç¤ºæ›´æ–°
        function updateUserInfo() {
            if (currentUser) {
                document.getElementById('currentUserName').textContent = currentUser.employeeName;
                document.getElementById('currentUserDept').textContent = currentUser.employeeDept;
                document.getElementById('currentUserCode').textContent = currentUser.employeeNumber;
            }
        }

        // ãƒ‡ãƒã‚¤ã‚¹ç™»éŒ²å‡¦ç†
        function registerDevice() {
            var empno = document.getElementById('setupEmpno').value.trim();
            
            if (!empno || empno.length !== 4) {
                showMsg('ç¤¾å“¡ç•ªå·4æ¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', true);
                return;
            }

            var empInfo = employees[empno];
            if (!empInfo) {
                showMsg('ç¤¾å“¡ç•ªå·ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', true);
                return;
            }

            if (empInfo.status === 'retired') {
                showMsg(`${empInfo.name}ã•ã‚“ã¯é€€è·æ¸ˆã¿ã§ã™ï¼ˆé€€è·æ—¥: ${empInfo.retireDate}ï¼‰`, true);
                return;
            }

            if (empInfo.status !== 'active') {
                showMsg('ç¾åœ¨åœ¨ç±ã—ã¦ã„ãªã„ç¤¾å“¡ç•ªå·ã§ã™', true);
                return;
            }

            if (saveDeviceInfo(empno, empInfo)) {
                currentUser = getDeviceInfo();
                showMainScreen();
                showMsg(empInfo.name + 'ã•ã‚“ã®ãƒ‡ãƒã‚¤ã‚¹ã‚’ç™»éŒ²ã—ã¾ã—ãŸ', false);
            } else {
                showMsg('ãƒ‡ãƒã‚¤ã‚¹ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ', true);
            }
        }

        // è‡ªå‹•ãƒ­ã‚°ã‚¤ãƒ³ãƒã‚§ãƒƒã‚¯
        function checkAutoLogin() {
            deviceId = localStorage.getItem('unified-timecard-device-id');
            if (!deviceId) {
                deviceId = generateDeviceId();
                localStorage.setItem('unified-timecard-device-id', deviceId);
                debug('æ–°ãƒ‡ãƒã‚¤ã‚¹IDç”Ÿæˆ: ' + deviceId.substr(0, 15) + '...');
            }

            currentUser = getDeviceInfo();
            if (currentUser) {
                debug('è‡ªå‹•ãƒ­ã‚°ã‚¤ãƒ³: ' + currentUser.employeeName);
                showMainScreen();
            } else {
                debug('åˆå›åˆ©ç”¨è€… - ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ç”»é¢è¡¨ç¤º');
                showInitialSetup();
            }
        }

        // æ™‚è¨ˆæ›´æ–°
        function updateClock() {
            const now = new Date();
            const timeStr = now.toLocaleString('ja-JP', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            });
            const clockEl = document.getElementById('clock');
            if (clockEl) {
                clockEl.textContent = timeStr;
            }
        }

        // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        function loadData() {
            try {
                var saved = localStorage.getItem('unified-timecard-data');
                if (saved) {
                    data = JSON.parse(saved);
                    debug('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿: ' + data.length + 'ä»¶');
                } else {
                    data = [];
                    debug('æ–°è¦ãƒ‡ãƒ¼ã‚¿');
                }
            } catch (e) {
                debug('èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ' + e.message);
                data = [];
            }
        }

        // ãƒ‡ãƒ¼ã‚¿ä¿å­˜
        function saveData() {
            try {
                localStorage.setItem('unified-timecard-data', JSON.stringify(data));
                // ç®¡ç†è€…ãƒ¢ãƒ¼ãƒ‰ã®ãƒ‡ãƒ¼ã‚¿ã‚‚æ›´æ–°
                allRecords = data.slice();
                if (document.getElementById('adminMode').classList.contains('active')) {
                    refreshAdminData();
                }
            } catch (e) {
                debug('ä¿å­˜ã‚¨ãƒ©ãƒ¼: ' + e.message);
                showMsg('ä¿å­˜å¤±æ•—', true);
            }
        }

        // æ‰“åˆ»å‡¦ç†
        function punch(type) {
            if (isProcessing) {
                debug('å‡¦ç†ä¸­ã®ãŸã‚ç„¡è¦–');
                return;
            }
            
            isProcessing = true;
            debug('æ‰“åˆ»é–‹å§‹: ' + type);
            
            var empno = '';
            var empName = '';
            var empInfo = null;
            
            if (currentUser) {
                empno = currentUser.employeeNumber;
                empName = currentUser.employeeName;
                empInfo = employees[empno];
                
                if (!empInfo) {
                    showMsg('ç¤¾å“¡æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒ‡ãƒã‚¤ã‚¹è¨­å®šã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦ãã ã•ã„ã€‚', true);
                    debug('ç¤¾å“¡æƒ…å ±ãªã—: ' + empno);
                    isProcessing = false;
                    return;
                }
                
                if (empInfo.status === 'retired') {
                    showMsg(`${empInfo.name}ã•ã‚“ã¯é€€è·æ¸ˆã¿ã§ã™ï¼ˆé€€è·æ—¥: ${empInfo.retireDate}ï¼‰ã€‚ãƒ‡ãƒã‚¤ã‚¹è¨­å®šã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦ãã ã•ã„ã€‚`, true);
                    debug('é€€è·æ¸ˆã¿: ' + empno);
                    isProcessing = false;
                    return;
                }
                
                if (empInfo.status !== 'active') {
                    showMsg('åœ¨ç±ã—ã¦ã„ãªã„ç¤¾å“¡ã§ã™ã€‚ãƒ‡ãƒã‚¤ã‚¹è¨­å®šã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦ãã ã•ã„ã€‚', true);
                    debug('éåœ¨ç±: ' + empno);
                    isProcessing = false;
                    return;
                }
                
                debug('è‡ªå‹•è­˜åˆ¥æ‰“åˆ»: ' + empName + '(' + empno + ')');
            } else {
                showMsg('ãƒ‡ãƒã‚¤ã‚¹ç™»éŒ²ãŒå¿…è¦ã§ã™', true);
                isProcessing = false;
                return;
            }

            if (navigator.vibrate) {
                navigator.vibrate(50);
            }

            var now = new Date();
            var record = {
                id: now.getTime(),
                emp: empno,
                empName: empName,
                empDept: empInfo.dept,
                date: now.toISOString().split('T')[0],
                time: now.toTimeString().split(' ')[0],
                type: type,
                timestamp: now.toISOString()
            };

            data.push(record);
            saveData();

            var names = {
                'checkin': 'å‡ºå‹¤',
                'checkout': 'é€€å‹¤',
                'out': 'å¤–å‡º',
                'return': 'æˆ»ã‚Š'
            };
            
            showMsg(empName + 'ã•ã‚“ã®' + names[type] + 'ã‚’è¨˜éŒ²ã—ã¾ã—ãŸ', false);
            debug('æ‰“åˆ»å®Œäº†: ' + empno + '-' + type);
            
            setTimeout(function() {
                isProcessing = false;
            }, 1000);
        }

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
        function showMsg(text, isError) {
            var msg = document.getElementById('message');
            if (msg) {
                msg.textContent = text;
                msg.className = isError ? 'message error' : 'message';
                msg.style.display = 'block';
                
                setTimeout(function() {
                    msg.style.display = 'none';
                }, 3000);
            }
        }

        // CSV ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        function downloadCSV() {
            try {
                if (data.length === 0) {
                    showMsg('ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“', true);
                    return;
                }

                const header = 'æ—¥ä»˜,ç¤¾å“¡ç•ªå·,æ°å,éƒ¨ç½²,æ™‚åˆ»,ç¨®åˆ¥';
                const typeNames = {
                    'checkin': 'å‡ºå‹¤',
                    'checkout': 'é€€å‹¤',
                    'out': 'å¤–å‡º',
                    'return': 'æˆ»ã‚Š'
                };

                const csvData = [header];
                
                data.forEach(record => {
                    const row = [
                        record.date,
                        record.emp,
                        record.empName || record.emp,
                        record.empDept || '',
                        record.time,
                        typeNames[record.type]
                    ];
                    csvData.push(row.join(','));
                });

                const csvContent = '\uFEFF' + csvData.join('\n');
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `timecard-${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showMsg('CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸï¼', false);
            } catch (error) {
                console.error('CSV ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼:', error);
                showMsg('CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ', true);
            }
        }

        // ===== ç®¡ç†è€…ãƒ¢ãƒ¼ãƒ‰æ©Ÿèƒ½ =====

        // ç®¡ç†è€…ãƒ‡ãƒ¼ã‚¿æ›´æ–°
        function refreshAdminData() {
            loadData();
            allRecords = data.slice();
            updateStats();
            filterRecords();
        }

        // çµ±è¨ˆæƒ…å ±æ›´æ–°
        function updateStats() {
            const today = new Date().toISOString().split('T')[0];
            
            const activeRecords = allRecords.filter(r => {
                const emp = employees[r.emp];
                return emp && emp.status === 'active';
            });
            
            const todayActiveRecords = activeRecords.filter(r => r.date === today);
            const uniqueActiveUsers = new Set(activeRecords.map(r => r.emp)).size;
            const totalActiveEmployees = Object.values(employees).filter(emp => emp.status === 'active').length;
            
            document.getElementById('totalRecords').textContent = activeRecords.length;
            document.getElementById('todayRecords').textContent = todayActiveRecords.length;
            document.getElementById('activeUsers').textContent = uniqueActiveUsers + '/' + totalActiveEmployees;
        }

        // ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
        function filterRecords() {
            const dateFilter = document.getElementById('dateFilter').value;
            const deptFilter = document.getElementById('deptFilter').value;
            const empFilter = document.getElementById('empFilter').value;
            const typeFilter = document.getElementById('typeFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;

            let filtered = allRecords;

            if (dateFilter) {
                filtered = filtered.filter(r => r.date === dateFilter);
            }

            if (deptFilter) {
                filtered = filtered.filter(r => r.empDept === deptFilter);
            }

            if (empFilter) {
                filtered = filtered.filter(r => r.emp.includes(empFilter));
            }

            if (typeFilter) {
                filtered = filtered.filter(r => r.type === typeFilter);
            }

            if (statusFilter === 'active') {
                filtered = filtered.filter(r => {
                    const emp = employees[r.emp];
                    return emp && emp.status === 'active';
                });
            } else if (statusFilter === 'retired') {
                filtered = filtered.filter(r => {
                    const emp = employees[r.emp];
                    return emp && emp.status === 'retired';
                });
            }

            displayRecords(filtered);
        }

        // ãƒ¬ã‚³ãƒ¼ãƒ‰è¡¨ç¤º
        function displayRecords(records) {
            const tbody = document.getElementById('recordsBody');
            
            if (records.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="no-data">è©²å½“ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
                return;
            }

            tbody.innerHTML = records.map(record => {
                const typeNames = {
                    'checkin': 'å‡ºå‹¤',
                    'checkout': 'é€€å‹¤',
                    'out': 'å¤–å‡º',
                    'return': 'æˆ»ã‚Š'
                };

                const emp = employees[record.emp];
                const isRetired = emp && emp.status === 'retired';
                const empDisplayName = record.empName || record.emp;
                const empName = isRetired ? `${empDisplayName} (é€€è·)` : empDisplayName;
                const deptClass = `dept-${record.empDept}`;

                return `
                    <tr ${isRetired ? 'style="opacity: 0.6; background: #f9f9f9;"' : ''}>
                        <td>${record.date}</td>
                        <td>${record.time}</td>
                        <td>${record.emp}</td>
                        <td>${empName}</td>
                        <td><span class="dept-badge ${deptClass}">${record.empDept}</span></td>
                        <td><span class="type-badge type-${record.type}">${typeNames[record.type]}</span></td>
                    </tr>
                `;
            }).join('');
        }

        // ç®¡ç†è€…CSVå‡ºåŠ›
        function exportAdminCSV() {
            try {
                if (allRecords.length === 0) {
                    alert('å‡ºåŠ›ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
                    return;
                }

                const headers = ['æ—¥ä»˜', 'ç¤¾å“¡ç•ªå·', 'æ°å', 'éƒ¨ç½²', 'æ™‚åˆ»', 'ç¨®åˆ¥'];
                const typeNames = {
                    'checkin': 'å‡ºå‹¤',
                    'checkout': 'é€€å‹¤',
                    'out': 'å¤–å‡º',
                    'return': 'æˆ»ã‚Š'
                };

                const csvData = [headers.join(',')];
                
                allRecords.forEach(record => {
                    const row = [
                        record.date,
                        record.emp,
                        record.empName || record.emp,
                        record.empDept || 'ãã®ä»–',
                        record.time,
                        typeNames[record.type]
                    ];
                    csvData.push(row.join(','));
                });

                const csvContent = '\uFEFF' + csvData.join('\n');
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `timecard-admin-${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                alert('ç®¡ç†è€…ç”¨CSVã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ');
            } catch (error) {
                console.error('CSVå‡ºåŠ›ã‚¨ãƒ©ãƒ¼:', error);
                alert('CSVå‡ºåŠ›ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        }

        // ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿è¿½åŠ 
        function loadTestData() {
            const testRecord = {
                id: Date.now(),
                emp: '2088',
                empName: 'å²©åŸ æ­£äºŒ',
                empDept: 'ãƒªã‚µã‚¤ã‚¯ãƒ«éƒ¨',
                date: new Date().toISOString().split('T')[0],
                time: new Date().toTimeString().split(' ')[0],
                type: 'checkin',
                timestamp: new Date().toISOString()
            };

            data.push(testRecord);
            saveData();
            alert('ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ ã—ã¾ã—ãŸ');
        }

        // å…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤
        function clearAllData() {
            if (confirm('å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚')) {
                data = [];
                allRecords = [];
                localStorage.removeItem('unified-timecard-data');
                updateStats();
                filterRecords();
                alert('å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
            }
        }

        // ===== åˆæœŸåŒ– =====

        document.addEventListener('DOMContentLoaded', function() {
            debug('çµ±åˆã‚¢ãƒ—ãƒªé–‹å§‹');
            
            // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
            loadData();
            allRecords = data.slice();
            
            // æ™‚è¨ˆé–‹å§‹
            updateClock();
            setInterval(updateClock, 1000);
            
            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæ—¥ä»˜è¨­å®š
            const today = new Date().toISOString().split('T')[0];
            const dateFilterEl = document.getElementById('dateFilter');
            if (dateFilterEl) {
                dateFilterEl.value = today;
            }
            
            // ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
            const buttons = document.querySelectorAll('.button');
            buttons.forEach(button => {
                button.addEventListener('click', function(e) {
                    e.preventDefault();
                    const type = this.getAttribute('data-type');
                    if (type) {
                        punch(type);
                    }
                });
            });

            // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰è¨­å®š
            const setupInput = document.getElementById('setupEmpno');
            if (setupInput) {
                setupInput.addEventListener('input', function(e) {
                    e.target.value = e.target.value.replace(/[^0-9]/g, '');
                });
            }
            
            // å¾“æ¥­å“¡ãƒ¢ãƒ¼ãƒ‰ã§é–‹å§‹
            switchMode('employee');
        });
    </script>
</body>
</html>